#!/usr/bin/env bash
set -euo pipefail

readonly SRC_DIR="src"
readonly OUTPUT_DIR="out"
readonly CV_SRC="${SRC_DIR}/cv.typ"
readonly LANG_CONFIG="${SRC_DIR}/languages.yaml"

mapfile -t AVAILABLE_LANGS < <(yq eval '.languages | keys | .[]' "$LANG_CONFIG")
DEFAULT_LANG=$(yq eval '.default' "$LANG_CONFIG")
readonly DEFAULT_LANG

die() {
	printf '%s\n' "$*" >&2
	exit 1
}

log() { printf '%s\n' "$*" >&2; }

usage() {
	cat >&2 <<EOF
Usage: cv <command> [options]

Commands:
  build [lang]     Build CV PDF (default: ${DEFAULT_LANG})
  build-all        Build CV PDFs for all languages
  check [lang]     Check CV compilation without building
  check-all        Check CV compilation for all languages
  validate         Validate data consistency across languages
  watch [lang]     Watch for changes and auto-rebuild
  help             Show this help message

Available languages: ${AVAILABLE_LANGS[*]}
EOF
}

build_cv() {
	local lang=${1:-$DEFAULT_LANG}
	local output_file="${OUTPUT_DIR}/jago-cv-${lang}.pdf"

	mkdir -p "$OUTPUT_DIR"
	log "Building CV (${lang})..."
	typst compile --root . --input lang="$lang" "$CV_SRC" "$output_file"
	log "Built: ${output_file}"
}

build_all_cv() {
	log "Building CVs for all languages..."
	local pids=() failed=()

	for lang in "${AVAILABLE_LANGS[@]}"; do
		build_cv "$lang" &
		pids+=($!)
	done

	local i=0
	for pid in "${pids[@]}"; do
		wait "$pid" || failed+=("${AVAILABLE_LANGS[$i]}")
		((i++))
	done

	((${#failed[@]} == 0)) && log "All CVs built successfully" && return
	die "Build failed for: ${failed[*]}"
}

check_cv() {
	local lang=${1:-$DEFAULT_LANG}

	log "Checking CV compilation (${lang})..."
	typst compile --root . --input lang="$lang" --format pdf "$CV_SRC" /dev/null
	log "Check passed (${lang})"
}

check_all_cv() {
	log "Checking CV compilation for all languages..."
	local failed=()

	for lang in "${AVAILABLE_LANGS[@]}"; do
		check_cv "$lang" && continue
		failed+=("$lang")
	done

	((${#failed[@]} == 0)) && log "All checks passed" && return
	die "Check failed for: ${failed[*]}"
}

validate_cv() {
	log "Validating data consistency..."
	local errors=0

	[[ -f "${SRC_DIR}/profile.yaml" ]] || {
		log "Missing: profile.yaml"
		((errors++))
	}

	for lang in "${AVAILABLE_LANGS[@]}"; do
		local locale_file="${SRC_DIR}/locales/${lang}.yaml"
		[[ -f "$locale_file" ]] || {
			log "Missing: ${locale_file}"
			((errors++))
		}
	done

	for lang in "${AVAILABLE_LANGS[@]}"; do
		check_cv "$lang" &>/dev/null || {
			log "Compilation failed: ${lang}"
			((errors++))
		}
	done

	((errors == 0)) && log "Validation passed" && return
	die "Validation failed with ${errors} error(s)"
}

watch_cv() {
	local lang=${1:-$DEFAULT_LANG}
	local output_file="${OUTPUT_DIR}/jago-cv-${lang}.pdf"

	mkdir -p "$OUTPUT_DIR"
	log "Watching for changes (${lang})..."
	typst watch --root . --input lang="$lang" "$CV_SRC" "$output_file"
}

main() {
	case ${1:-help} in
	help | --help | -h) usage ;;
	build) build_cv "${2:-}" ;;
	build-all) build_all_cv ;;
	check) check_cv "${2:-}" ;;
	check-all) check_all_cv ;;
	validate) validate_cv ;;
	watch) watch_cv "${2:-}" ;;
	*) die "Unknown command: $1. Run 'cv help' for usage." ;;
	esac
}

main "$@"
